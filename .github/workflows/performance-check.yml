name: Performance Check

on:
  # Run on every push to main (after deployment)
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'

  # Manual trigger
  workflow_dispatch:

jobs:
  quick-performance-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Wait for deployment
        run: |
          echo "Waiting 30 seconds for Vercel deployment to complete..."
          sleep 30

      - name: Quick health check
        id: health_check
        run: |
          cd load-tests
          k6 run --vus 5 --duration 30s 01-health-check.js --out json=quick-results.json
        continue-on-error: true

      - name: Parse results
        id: parse_results
        run: |
          cd load-tests
          if [ -f "quick-results.json" ]; then
            # Extract last line which contains the summary
            SUMMARY=$(tail -1 quick-results.json)

            # Parse metrics (simplified - in production use jq)
            echo "Results parsed successfully"
            echo "results_available=true" >> $GITHUB_OUTPUT
          else
            echo "results_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Create performance report
        run: |
          echo "## ðŸ“Š Performance Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment**: $(git log -1 --pretty=format:'%h - %s')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: https://clientportal-vert.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "load-tests/quick-results.json" ]; then
            echo "### Quick Test Results" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Health check passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ˆ Full results available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Health check failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  Investigation required" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-check-${{ github.sha }}
          path: load-tests/quick-results.json
          retention-days: 90

      - name: Check thresholds
        run: |
          cd load-tests
          if grep -q '"failed"' quick-results.json 2>/dev/null; then
            echo "::warning::Performance thresholds not met after deployment"
            echo "::warning::Review the performance check artifacts"
            # Don't fail the workflow, just warn
          else
            echo "âœ… Performance thresholds met"
          fi
